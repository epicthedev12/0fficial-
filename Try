local LoadingScreen = {}
LoadingScreen.__index = LoadingScreen

function LoadingScreen.new(title, totalSteps)
    local self = setmetatable({}, LoadingScreen)
    self.title = title or "Loading..."
    self.totalSteps = totalSteps or 100
    self.currentStep = 0
    self.messages = {}
    self.isVisible = false
    self.startTime = nil
    self.animationFrame = 0
    self.tipIndex = 1
    self.lastTipChange = 0
    
    self.loadingTips = {
        "ğŸ’¡ Tip: This loading screen has animations!",
        "ğŸ® Tip: Take a moment to stretch!",
        "âš¡ Tip: Patience makes loading faster!",
        "ğŸŒŸ Tip: Each progress fill is a victory!",
        "ğŸ¯ Tip: Perfect time for mini meditation!",
        "ğŸ”® Tip: Something awesome is coming!",
        "ğŸš€ Tip: Good things take time!",
        "â­ Tip: Amazing experience loading..."
    }
    
    self.spinnerFrames = {"â—", "â—“", "â—‘", "â—’"}
    self.progressStyles = {
        {filled = "â–ˆ", empty = "â–‘"},
        {filled = "â–°", empty = "â–±"},
        {filled = "â—", empty = "â—‹"},
        {filled = "â™¦", empty = "â™¢"}
    }
    self.currentStyle = 1
    self.styleChangeTime = 0
    
    return self
end

function LoadingScreen:show()
    self.isVisible = true
    self.startTime = os.clock()
    self.lastTipChange = self.startTime
    self.styleChangeTime = self.startTime
    self:render()
end

function LoadingScreen:hide()
    self.isVisible = false
    self:clearScreen()
    self:showCompletionAnimation()
end

function LoadingScreen:clearScreen()
    os.execute("clear || cls")
end

function LoadingScreen:updateProgress(step, message)
    if step then
        self.currentStep = step
    else
        self.currentStep = self.currentStep + 1
    end
    
    if message then
        table.insert(self.messages, "ğŸ“¦ " .. message)
        if #self.messages > 2 then
            table.remove(self.messages, 1)
        end
    end
    
    self.animationFrame = self.animationFrame + 1
    
    local currentTime = os.clock()
    if currentTime - self.styleChangeTime > 8 then
        self.currentStyle = (self.currentStyle % #self.progressStyles) + 1
        self.styleChangeTime = currentTime
    end
    
    if currentTime - self.lastTipChange > 4 then
        self.tipIndex = (self.tipIndex % #self.loadingTips) + 1
        self.lastTipChange = currentTime
    end
    
    if self.isVisible then
        self:render()
    end
end

function LoadingScreen:createProgressBar()
    local progress = math.min(self.currentStep / self.totalSteps, 1.0)
    local barWidth = 30
    local filledWidth = math.floor(progress * barWidth)
    local style = self.progressStyles[self.currentStyle]
    
    local progressBar = "["
    for i = 1, barWidth do
        if i <= filledWidth then
            if self.animationFrame % 6 == i % 6 then
                progressBar = progressBar .. "â–“"
            else
                progressBar = progressBar .. style.filled
            end
        else
            progressBar = progressBar .. style.empty
        end
    end
    progressBar = progressBar .. "]"
    
    return progressBar
end

function LoadingScreen:createDancingTitle()
    local dancingTitle = ""
    for i = 1, #self.title do
        local char = self.title:sub(i, i)
        if (self.animationFrame + i) % 4 < 2 then
            dancingTitle = dancingTitle .. char:upper()
        else
            dancingTitle = dancingTitle .. char:lower()
        end
    end
    return dancingTitle
end

function LoadingScreen:render()
    self:clearScreen()
    
    local progress = math.min(self.currentStep / self.totalSteps, 1.0)
    local percentage = math.floor(progress * 100)
    local progressBar = self:createProgressBar()
    local spinner = self.spinnerFrames[(self.animationFrame % 4) + 1]
    local dancingTitle = self:createDancingTitle()
    
    local elapsed = self.startTime and (os.clock() - self.startTime) or 0
    local elapsedStr = string.format("%.1fs", elapsed)
    
    local remaining = ""
    if progress > 0.05 then
        local totalEstimate = elapsed / progress
        local remainingTime = math.max(0, totalEstimate - elapsed)
        remaining = string.format(" | ETA: %.1fs", remainingTime)
    end
    
    print("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    print("â•‘ " .. spinner .. " " .. dancingTitle .. string.rep(" ", 34 - #self.title) .. " â•‘")
    print("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£")
    print("â•‘                                        â•‘")
    print("â•‘ " .. progressBar .. " " .. percentage .. "%" .. string.rep(" ", 4 - #tostring(percentage)) .. " â•‘")
    
    local energyLevel = "ğŸ”¥ Level " .. math.floor(progress * 10) .. " Energy"
    if progress >= 1.0 then
        energyLevel = "ğŸ‰ MAXIMUM POWER! ğŸ‰"
    end
    print("â•‘ " .. energyLevel .. string.rep(" ", 37 - #energyLevel) .. " â•‘")
    
    print("â•‘                                        â•‘")
    
    local stepInfo = "ğŸ“Š " .. self.currentStep .. "/" .. self.totalSteps .. " | â±ï¸ " .. elapsedStr .. remaining
    if #stepInfo > 36 then stepInfo = stepInfo:sub(1, 33) .. "..." end
    print("â•‘ " .. stepInfo .. string.rep(" ", 37 - #stepInfo) .. " â•‘")
    
    print("â•‘                                        â•‘")
    
    if #self.messages > 0 then
        for i = 1, #self.messages do
            local msg = self.messages[i]
            if #msg > 36 then msg = msg:sub(1, 33) .. "..." end
            print("â•‘ " .. msg .. string.rep(" ", 37 - #msg) .. " â•‘")
        end
    else
        print("â•‘ ğŸ”„ Processing...                      â•‘")
    end
    
    print("â•‘                                        â•‘")
    
    local tip = self.loadingTips[self.tipIndex]
    if #tip > 36 then tip = tip:sub(1, 33) .. "..." end
    print("â•‘ " .. tip .. string.rep(" ", 37 - #tip) .. " â•‘")
    
    print("â•‘                                        â•‘")
    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    
    local footerMessages = {
        "ğŸ® Press CTRL+C to cancel",
        "âš¡ Loading at warp speed...",
        "ğŸš€ Preparing for takeoff...",
        "ğŸŒŸ Magic is happening...",
        "ğŸ¯ Almost there, champion!"
    }
    
    local footerMsg = footerMessages[(self.animationFrame % #footerMessages) + 1]
    print("   " .. footerMsg)
    
    self:sleep(0.15)
end

function LoadingScreen:sleep(seconds)
    if package.config:sub(1,1) == '\\' then
        os.execute("timeout /t " .. seconds .. " >nul")
    else
        os.execute("sleep " .. seconds)
    end
end

function LoadingScreen:showCompletionAnimation()
    local frames = {"ğŸ‰ COMPLETE! ğŸ‰", "âœ¨ SUCCESS! âœ¨", "ğŸš€ READY! ğŸš€"}
    
    for i, frame in ipairs(frames) do
        self:clearScreen()
        print("\n\n  â•”" .. string.rep("â•", #frame + 2) .. "â•—")
        print("  â•‘ " .. frame .. " â•‘")
        print("  â•š" .. string.rep("â•", #frame + 2) .. "â•")
        self:sleep(0.4)
    end
    
    self:clearScreen()
    print("\nğŸ® Welcome! Let's go! ğŸ®\n")
end

function LoadingScreen:simulateLoading()
    local tasks = {
        "Initializing engine",
        "Loading world",
        "Spawning entities",
        "Loading player data",
        "Preparing graphics",
        "Final setup"
    }
    
    self:show()
    
    for i, task in ipairs(tasks) do
        local progress = math.floor((i / #tasks) * self.totalSteps)
        self:updateProgress(progress, task)
        self:sleep(math.random(80, 200) / 100)
    end
    
    self:updateProgress(self.totalSteps, "Ready!")
    self:sleep(1)
    self:hide()
end

return LoadingScreen
